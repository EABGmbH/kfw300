#!/usr/bin/env python3
"""
KfW 300 Zinssätze Scraper
Lädt täglich die aktuellen Zinssätze von der KfW-Website und speichert sie als JSON
"""

import requests
from bs4 import BeautifulSoup
import json
from datetime import datetime
import re

def scrape_kfw_zinsen():
    """
    Scrapt die KfW-Website für Programm 300 Zinssätze
    """
    # KfW 300 Konditionsseite
    url = "https://www.kfw.de/inlandsfoerderung/Privatpersonen/Neubau/F%C3%B6rderprodukte/Wohneigentum-f%C3%BCr-Familien-(300)/"
    
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    
    try:
        response = requests.get(url, headers=headers, timeout=10)
        response.raise_for_status()
        
        soup = BeautifulSoup(response.content, 'html.parser')
        
        # Zinssätze extrahieren (anpassen an tatsächliche HTML-Struktur)
        # Dies ist ein Template - muss an die tatsächliche Struktur angepasst werden
        zinsen = {
            "updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "program": "KfW 300 - Wohneigentum für Familien",
            "rates": {
                "4-10_jahre": {
                    "laufzeit": "4 bis 10 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 2 Jahre",
                    "sollzins": 0.0,
                    "effektivzins": 0.0
                },
                "11-25_jahre": {
                    "laufzeit": "11 bis 25 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 3 Jahre",
                    "sollzins": 0.0,
                    "effektivzins": 0.0
                },
                "26-35_jahre": {
                    "laufzeit": "26 bis 35 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 5 Jahre",
                    "sollzins": 0.0,
                    "effektivzins": 0.0
                }
            },
            "source_url": url
        }
        
        # Versuche Zinssätze zu finden (diese Selektoren müssen angepasst werden!)
        # Beispiel für mögliche Struktur:
        zins_tabelle = soup.find('table', {'class': lambda x: x and 'konditionen' in x.lower() if x else False})
        
        if zins_tabelle:
            rows = zins_tabelle.find_all('tr')
            for row in rows:
                cols = row.find_all('td')
                if len(cols) >= 2:
                    text = ' '.join([col.get_text(strip=True) for col in cols])
                    
                    # Suche nach Zinssätzen (Format: X,XX %)
                    zins_matches = re.findall(r'(\d+[,\.]\d+)\s*%', text)
                    
                    if '4' in text and '10' in text and zins_matches:
                        zinsen['rates']['4-10_jahre']['sollzins'] = float(zins_matches[0].replace(',', '.'))
                        if len(zins_matches) > 1:
                            zinsen['rates']['4-10_jahre']['effektivzins'] = float(zins_matches[1].replace(',', '.'))
                    
                    elif '11' in text and '25' in text and zins_matches:
                        zinsen['rates']['11-25_jahre']['sollzins'] = float(zins_matches[0].replace(',', '.'))
                        if len(zins_matches) > 1:
                            zinsen['rates']['11-25_jahre']['effektivzins'] = float(zins_matches[1].replace(',', '.'))
                    
                    elif '26' in text and '35' in text and zins_matches:
                        zinsen['rates']['26-35_jahre']['sollzins'] = float(zins_matches[0].replace(',', '.'))
                        if len(zins_matches) > 1:
                            zinsen['rates']['26-35_jahre']['effektivzins'] = float(zins_matches[1].replace(',', '.'))
        
        # Fallback: Wenn Scraping fehlschlägt, verwende Platzhalter
        if all(zinsen['rates'][key]['sollzins'] == 0.0 for key in zinsen['rates']):
            print("⚠️ Warnung: Keine Zinssätze gefunden. Bitte HTML-Struktur prüfen!")
            print("Verwende Platzhalter-Werte...")
            
            # Platzhalter (müssen manuell aktualisiert werden)
            zinsen['rates']['4-10_jahre']['sollzins'] = 2.15
            zinsen['rates']['4-10_jahre']['effektivzins'] = 2.17
            zinsen['rates']['11-25_jahre']['sollzins'] = 2.45
            zinsen['rates']['11-25_jahre']['effektivzins'] = 2.48
            zinsen['rates']['26-35_jahre']['sollzins'] = 2.67
            zinsen['rates']['26-35_jahre']['effektivzins'] = 2.71
            zinsen['manual_update_required'] = True
        
        # Speichere als JSON
        with open('zinsen-kfw300.json', 'w', encoding='utf-8') as f:
            json.dump(zinsen, f, indent=2, ensure_ascii=False)
        
        print("✅ Erfolgreich! Zinssätze aktualisiert:")
        print(json.dumps(zinsen, indent=2, ensure_ascii=False))
        
        return zinsen
        
    except Exception as e:
        print(f"❌ Fehler beim Scraping: {e}")
        
        # Erstelle minimale JSON mit Fehlermeldung
        error_data = {
            "updated": datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            "error": str(e),
            "message": "Scraping fehlgeschlagen. Bitte manuell prüfen.",
            "rates": {
                "4-10_jahre": {
                    "laufzeit": "4 bis 10 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 2 Jahre",
                    "sollzins": None,
                    "effektivzins": None
                },
                "11-25_jahre": {
                    "laufzeit": "11 bis 25 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 3 Jahre",
                    "sollzins": None,
                    "effektivzins": None
                },
                "26-35_jahre": {
                    "laufzeit": "26 bis 35 Jahre",
                    "zinsbindung": "10 Jahre",
                    "tilgungsfrei": "1 bis 5 Jahre",
                    "sollzins": None,
                    "effektivzins": None
                }
            }
        }
        
        with open('zinsen-kfw300.json', 'w', encoding='utf-8') as f:
            json.dump(error_data, f, indent=2, ensure_ascii=False)
        
        raise

if __name__ == "__main__":
    scrape_kfw_zinsen()
