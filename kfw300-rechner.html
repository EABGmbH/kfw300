<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KfW 300 F√∂rderrechner - Wohneigentum f√ºr Familien</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #3b5748;
            min-height: 100vh;
            padding: 40px 20px;
            color: white;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .header {
            color: white;
            margin-bottom: 25px;
            padding: 12px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 1em;
            opacity: 0.95;
            line-height: 1.3;
        }

        .calculator-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.12);
            padding: 35px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Info Banner */
        .info-banner {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .info-banner-content {
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .info-banner-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .info-banner h3 {
            color: #856404;
            font-size: 1em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .info-banner p {
            color: #856404;
            font-size: 0.9em;
            line-height: 1.5;
            margin: 0;
        }

        /* Fortschrittsanzeige */
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 15px 10px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-width: 70px;
        }

        .progress-dot {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1em;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
        }

        .progress-step.active .progress-dot {
            background: #50685b;
            color: white;
            border-color: #50685b;
            transform: scale(1.1);
        }

        .progress-step.completed .progress-dot {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .progress-step.completed .progress-dot::after {
            content: '‚úì';
            font-size: 1.5em;
        }

        .progress-label {
            margin-top: 8px;
            font-size: 0.75em;
            color: #333;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        .progress-step.active .progress-label {
            color: #50685b;
            font-weight: 700;
        }

        .progress-line {
            flex: 1;
            height: 2px;
            background: #e0e0e0;
            margin: 0 5px;
            margin-bottom: 25px;
            max-width: 60px;
        }

        /* Form Steps */
        .form-step {
            display: none;
        }

        .form-step.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        .section-question {
            display: block;
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.4;
        }

        .section-hint {
            text-align: center;
            color: #666;
            font-size: 0.95em;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        /* Slider f√ºr Kinder */
        .slider-container {
            max-width: 500px;
            margin: 30px auto;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #50685b;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #42574c;
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #50685b;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #50685b;
            min-width: 60px;
            text-align: center;
        }

        .error-message {
            color: #c62828;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .success-message {
            color: #2e7d32;
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            font-size: 0.95em;
        }

        /* Einkommen Input */
        .income-input-wrapper {
            max-width: 450px;
            margin: 30px auto;
            position: relative;
        }

        .income-input-wrapper .input-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5em;
            color: #50685b;
            pointer-events: none;
        }

        .income-input-wrapper input {
            width: 100%;
            font-size: 1.5em;
            font-weight: 600;
            padding: 20px 20px 20px 60px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .income-input-wrapper input:hover {
            border-color: #50685b;
            background: #f9f9f9;
        }

        .income-input-wrapper input:focus {
            outline: none;
            border-color: #50685b;
            box-shadow: 0 0 0 3px rgba(80, 104, 91, 0.15);
        }

        .income-limit-info {
            text-align: center;
            margin-top: 15px;
            color: #2e7d32;
            font-weight: 600;
            font-size: 0.95em;
        }

        /* Karten-Auswahl */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .option-card {
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .option-card:hover {
            background: #e8f0ed;
            border-color: #50685b;
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(80, 104, 91, 0.2);
        }

        .option-card.selected {
            background: #50685b;
            border-color: #50685b;
            color: white;
            box-shadow: 0 5px 20px rgba(80, 104, 91, 0.4);
        }

        .option-card .card-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .option-card.selected .card-icon {
            filter: brightness(0) invert(1);
        }

        .option-card .card-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            line-height: 1.3;
            margin-bottom: 5px;
        }

        .option-card.selected .card-label {
            color: white;
        }

        .option-card .card-sublabel {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .option-card.selected .card-sublabel {
            color: rgba(255, 255, 255, 0.9);
        }

        .option-card .card-description {
            font-size: 0.8em;
            color: #666;
            margin-top: 8px;
            line-height: 1.4;
        }

        .option-card.selected .card-description {
            color: rgba(255, 255, 255, 0.85);
        }

        /* Erkl√§rung Toggle */
        .explanation-toggle {
            margin-top: 25px;
            background: #e3f2fd;
            border: 2px solid #2196F3;
            border-radius: 10px;
            overflow: hidden;
        }

        .explanation-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #e3f2fd;
            transition: background 0.3s ease;
        }

        .explanation-header:hover {
            background: #bbdefb;
        }

        .explanation-title {
            color: #1565c0;
            font-weight: 600;
            font-size: 1em;
        }

        .explanation-arrow {
            color: #1565c0;
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .explanation-header.active .explanation-arrow {
            transform: rotate(180deg);
        }

        .explanation-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 20px;
        }

        .explanation-content.show {
            max-height: 800px;
            padding: 20px;
        }

        .explanation-content p {
            color: #1565c0;
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .explanation-content strong {
            color: #0d47a1;
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn-navigate {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-previous {
            background: #e0e0e0;
            color: #333;
        }

        .btn-previous:hover {
            background: #d0d0d0;
            transform: translateY(-2px);
        }

        .btn-next {
            background: #50685b;
            color: white;
        }

        .btn-next:hover {
            background: #42574c;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(80, 104, 91, 0.4);
        }

        .btn-next:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Ergebnis */
        .result-section {
            margin-top: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        .result-section.hidden {
            display: none;
        }

        .ergebnis-summary-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 6px solid #4caf50;
            border-radius: 12px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            text-align: center;
        }

        .result-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .ergebnis-summary-box h2 {
            color: #1b5e20;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .ergebnis-summary-box .big-amount {
            font-size: 3em;
            font-weight: 700;
            color: #1b5e20;
            margin: 20px 0;
        }

        .ergebnis-summary-box p {
            color: #2e7d32;
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .result-card {
            background: #f0f5f2;
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            border-left: 4px solid #50685b;
        }

        .result-card h3 {
            color: #50685b;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #555;
            font-size: 1em;
        }

        .result-value {
            color: #50685b;
            font-weight: 600;
            font-size: 1.05em;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .info-box p {
            color: #1565c0;
            font-size: 0.95em;
            line-height: 1.6;
            margin: 0;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .warning-box p {
            color: #856404;
            font-size: 0.95em;
            line-height: 1.6;
            margin: 0;
        }

        .conditions-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .conditions-table thead {
            background: #50685b;
            color: white;
        }

        .conditions-table th {
            padding: 12px;
            text-align: center;
            font-size: 0.9em;
            font-weight: 600;
        }

        .conditions-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
            font-size: 0.9em;
            text-align: center;
        }

        .conditions-table tbody tr:last-child td {
            border-bottom: none;
        }

        .conditions-table tbody tr:hover {
            background: #f5f5f5;
        }

        .conditions-intro {
            color: #555;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .error-result-box {
            background: #ffebee;
            border-left: 6px solid #c62828;
            border-radius: 12px;
            padding: 35px;
            text-align: center;
        }

        .error-result-box h2 {
            color: #c62828;
            font-size: 1.6em;
            margin-bottom: 20px;
        }

        .error-result-box ul {
            text-align: left;
            max-width: 500px;
            margin: 20px auto;
            list-style: none;
            padding: 0;
        }

        .error-result-box li {
            color: #d32f2f;
            padding: 10px 0;
            border-bottom: 1px solid #ffcdd2;
        }

        .error-result-box li:before {
            content: "‚ùå ";
            margin-right: 8px;
        }

        /* Footer */
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: white;
            opacity: 0.8;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .subtitle {
                font-size: 0.9em;
            }

            .calculator-card {
                padding: 20px;
            }

            .section-question {
                font-size: 1.1em;
            }

            .progress-indicator {
                overflow-x: auto;
                justify-content: flex-start;
                padding: 10px 5px;
            }

            .progress-step {
                min-width: 60px;
            }

            .progress-dot {
                width: 35px;
                height: 35px;
                font-size: 0.9em;
            }

            .progress-label {
                font-size: 0.65em;
            }

            .progress-line {
                max-width: 30px;
            }

            .card-grid {
                grid-template-columns: 1fr;
            }

            .slider-value {
                font-size: 2em;
            }

            .step-navigation {
                flex-direction: column;
            }

            .btn-navigate {
                width: 100%;
            }

            .ergebnis-summary-box .big-amount {
                font-size: 2em;
            }

            .conditions-table {
                font-size: 0.75em;
            }

            .conditions-table th,
            .conditions-table td {
                padding: 8px 6px;
                display: block;
                text-align: left;
            }

            .conditions-table thead {
                display: none;
            }

            .conditions-table tr {
                border-bottom: 2px solid #e0e0e0;
                display: block;
                margin-bottom: 10px;
            }

            .conditions-table td:before {
                content: attr(data-label);
                font-weight: 600;
                display: block;
                color: #50685b;
                margin-bottom: 4px;
            }

            /* Vergleichskasten responsive */
            .result-card div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }

            /* CTA Boxen responsive */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
    
    <!-- jsPDF Library f√ºr PDF-Generierung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Calculator Card -->
        <div class="calculator-card">
            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">
                    <div class="progress-dot">1</div>
                    <span class="progress-label">Kinder</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="progress-dot">2</div>
                    <span class="progress-label">Einkommen</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="progress-dot">3</div>
                    <span class="progress-label">Eigentum</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="4">
                    <div class="progress-dot">4</div>
                    <span class="progress-label">Standard</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="5">
                    <div class="progress-dot">5</div>
                    <span class="progress-label">Ergebnis</span>
                </div>
            </div>

            <form id="kfwForm">
                <!-- Schritt 1: Kinder -->
                <div class="form-step active" data-step="1">
                    <span class="section-question">
                        Wie viele Kinder (unter 18 Jahren) leben in Ihrem Haushalt?
                    </span>
                    
                    <div class="slider-container">
                        <div class="slider-wrapper">
                            <input type="range" id="childrenSlider" class="slider" min="0" max="10" value="1">
                            <div class="slider-value" id="childrenValue">1</div>
                        </div>
                        <div id="childrenError" class="error-message" style="display: none;">
                            ‚ö†Ô∏è Mindestens 1 Kind erforderlich f√ºr die F√∂rderung
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="btn-navigate btn-next" onclick="nextStep(1)">Weiter</button>
                    </div>
                </div>

                <!-- Schritt 2: Einkommen -->
                <div class="form-step" data-step="2">
                    <span class="section-question">
                        Durchschnittliches zu versteuerndes Einkommen (zvE)
                    </span>
                    <p class="section-hint">
                        Berechnen Sie den Durchschnitt Ihres zvE aus dem Jahr 2023 und 2024.
                    </p>

                    <div class="income-input-wrapper">
                        <span class="input-icon">‚Ç¨</span>
                        <input type="text" id="incomeInput" placeholder="z.B. 65.000" inputmode="numeric">
                    </div>
                    
                    <div id="incomeLimit" class="income-limit-info"></div>
                    <div id="incomeError" class="error-message" style="display: none;"></div>

                    <div class="step-navigation">
                        <button type="button" class="btn-navigate btn-previous" onclick="previousStep(2)">Zur√ºck</button>
                        <button type="button" class="btn-navigate btn-next" onclick="nextStep(2)">Weiter</button>
                    </div>
                </div>

                <!-- Schritt 3: Immobilieneigentum -->
                <div class="form-step" data-step="3">
                    <span class="section-question">
                        Besitzen Sie bereits Wohneigentum?
                    </span>

                    <div class="card-grid">
                        <div class="option-card" data-value="no" onclick="selectProperty('no')">
                            <div class="card-icon">‚úÖ</div>
                            <div class="card-label">Nein</div>
                        </div>
                        <div class="option-card" data-value="yes" onclick="selectProperty('yes')">
                            <div class="card-icon">üè†</div>
                            <div class="card-label">Ja</div>
                        </div>
                    </div>

                    <div id="propertyError" class="error-message" style="display: none;">
                        ‚ö†Ô∏è Bei bestehendem Wohneigentum ist keine F√∂rderung m√∂glich
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="btn-navigate btn-previous" onclick="previousStep(3)">Zur√ºck</button>
                        <button type="button" class="btn-navigate btn-next" id="propertyNextBtn" onclick="nextStep(3)" disabled>Weiter</button>
                    </div>
                </div>

                <!-- Schritt 4: Geb√§udestandard -->
                <div class="form-step" data-step="4">
                    <span class="section-question">
                        Erf√ºllt Ihr Neubau den KfW-Standard?
                    </span>
                    <p class="section-hint">
                        ‚ö†Ô∏è <strong>Wichtig:</strong> Der "Klimafreundliche Neubau"-Standard ist Pflicht f√ºr die F√∂rderung. Optional k√∂nnen Sie noch das QNG-Siegel anstreben.
                    </p>

                    <div class="card-grid">
                        <div class="option-card" data-value="kfn" onclick="selectStandard('kfn')">
                            <div class="card-icon">üå±</div>
                            <div class="card-label">Ja, KFN-Standard</div>
                            <div class="card-sublabel">‚úì Basis-Voraussetzung</div>
                            <div class="card-description">EH40-Effizienzhaus mit Nachhaltigkeitskriterien</div>
                        </div>
                        <div class="option-card" data-value="qng" onclick="selectStandard('qng')">
                            <div class="card-icon">‚≠ê</div>
                            <div class="card-label">Ja + QNG-Siegel</div>
                            <div class="card-sublabel">‚òÖ Optional f√ºr mehr F√∂rderung</div>
                            <div class="card-description">Zus√§tzliches Qualit√§tssiegel Nachhaltiges Geb√§ude</div>
                        </div>
                    </div>

                    <!-- Erkl√§rung Toggle -->
                    <div class="explanation-toggle">
                        <div class="explanation-header" onclick="toggleExplanation()">
                            <span class="explanation-title">üìö Was bedeutet das konkret f√ºr mich?</span>
                            <span class="explanation-arrow">‚ñº</span>
                        </div>
                        <div class="explanation-content">
                            <p><strong>‚Ä¢ KFN-Standard ist Pflicht:</strong></p>
                            <p>Ohne den "Klimafreundlichen Neubau"-Standard (EH40-Effizienzhaus) gibt es keine KfW-300-F√∂rderung.</p>
                            
                            <p><strong>‚Ä¢ QNG ist ein freiwilliges Upgrade:</strong></p>
                            <p>Das "Qualit√§tssiegel Nachhaltiges Geb√§ude" ist eine zus√§tzliche Zertifizierung, die strengere Nachhaltigkeitskriterien verlangt. Kostet ca. 3-5% mehr, bringt aber 50.000‚Ç¨ mehr Kredit.</p>
                            
                            <p><strong>‚Ä¢ Faustregel f√ºr diesen Rechner:</strong></p>
                            <p>Im Zweifel w√§hlen Sie "Ja, KFN-Standard" ohne QNG. Das trifft auf 80-90% aller Familien zu und ist v√∂llig ausreichend f√ºr eine satte F√∂rderung.</p>
                        </div>
                    </div>

                    <div class="step-navigation">
                        <button type="button" class="btn-navigate btn-previous" onclick="previousStep(4)">Zur√ºck</button>
                        <button type="button" class="btn-navigate btn-next" id="standardNextBtn" onclick="calculateResult()" disabled>Ergebnis berechnen</button>
                    </div>
                </div>
            </form>

            <!-- Ergebnis -->
            <div id="resultSection" class="result-section hidden"></div>
        </div>

        <!-- Disclaimer -->
        <div class="warning-box" style="margin-top: 25px;">
            <p>
                <strong>‚ÑπÔ∏è Rechtlicher Hinweis:</strong> Diese Berechnung dient nur zur Orientierung und stellt keine 
                offizielle Zusage der KfW dar. Die tats√§chliche F√∂rderf√§higkeit wird durch die KfW im Antragsverfahren 
                gepr√ºft. Stand: Februar 2026.
            </p>
        </div>
    </div>

    <script>
        // JSON URLs - f√ºr lokale Tests wird die lokale Datei verwendet
        const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/EABGmbH/kfw300/main/zinsen-kfw300.json';
        const LOCAL_JSON_URL = './zinsen-kfw300.json';
        
        // F√ºr lokale Tests: setze auf true, f√ºr Produktion: false
        const USE_LOCAL_JSON = false;
        
        // Zinsdaten global speichern
        let zinsdaten = null;

        // Lade Zinss√§tze beim Start
        async function loadZinssaetze() {
            const jsonUrl = USE_LOCAL_JSON ? LOCAL_JSON_URL : GITHUB_JSON_URL;
            
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error('JSON konnte nicht geladen werden');
                
                zinsdaten = await response.json();
                console.log('‚úÖ Zinss√§tze geladen:', zinsdaten);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Zinss√§tze:', error);
                // Fallback: Zeige "Tagesaktuell auf kfw.de" wenn Laden fehlschl√§gt
                zinsdaten = null;
            }
        }

        // Form Data
        let formData = {
            children: 1,
            income: 0,
            hasProperty: '',
            buildingStandard: ''
        };

        let currentStep = 1;

        // Children Slider
        const childrenSlider = document.getElementById('childrenSlider');
        const childrenValue = document.getElementById('childrenValue');
        const childrenError = document.getElementById('childrenError');

        childrenSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            formData.children = value;
            childrenValue.textContent = value;
            
            if (value === 0) {
                childrenError.style.display = 'block';
            } else {
                childrenError.style.display = 'none';
            }
            
            updateIncomeLimit();
        });

        // Income Input
        const incomeInput = document.getElementById('incomeInput');
        const incomeLimit = document.getElementById('incomeLimit');
        const incomeError = document.getElementById('incomeError');

        incomeInput.addEventListener('input', (e) => {
            // Remove all non-digit characters
            let value = e.target.value.replace(/\D/g, '');
            
            // Update form data
            formData.income = parseFloat(value) || 0;
            
            // Format with thousands separator
            if (value) {
                e.target.value = parseInt(value).toLocaleString('de-DE');
            }
            
            validateIncome();
        });

        function updateIncomeLimit() {
            const limit = calculateIncomeLimit(formData.children);
            if (formData.children > 0) {
                incomeLimit.textContent = `‚úì Einkommensgrenze f√ºr ${formData.children} ${formData.children === 1 ? 'Kind' : 'Kinder'}: ${limit.toLocaleString('de-DE')} ‚Ç¨`;
                incomeLimit.style.display = 'block';
            } else {
                incomeLimit.style.display = 'none';
            }
            validateIncome();
        }

        function calculateIncomeLimit(children) {
            if (children === 0) return 0;
            return 90000 + (children - 1) * 10000;
        }

        function validateIncome() {
            if (formData.children === 0 || formData.income === 0) {
                incomeError.style.display = 'none';
                return true;
            }
            
            const limit = calculateIncomeLimit(formData.children);
            if (formData.income > limit) {
                incomeError.textContent = `‚ö†Ô∏è Ihr Einkommen √ºberschreitet die F√∂rdergrenze von ${limit.toLocaleString('de-DE')} ‚Ç¨`;
                incomeError.style.display = 'block';
                return false;
            } else {
                incomeError.style.display = 'none';
                return true;
            }
        }

        // Property Selection
        function selectProperty(value) {
            formData.hasProperty = value;
            
            const cards = document.querySelectorAll('[data-step="3"] .option-card');
            cards.forEach(card => {
                if (card.dataset.value === value) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            const propertyError = document.getElementById('propertyError');
            const nextBtn = document.getElementById('propertyNextBtn');
            
            if (value === 'yes') {
                propertyError.style.display = 'block';
                nextBtn.disabled = true;
            } else {
                propertyError.style.display = 'none';
                nextBtn.disabled = false;
            }
        }

        // Standard Selection
        function selectStandard(value) {
            formData.buildingStandard = value;
            
            const cards = document.querySelectorAll('[data-step="4"] .option-card');
            cards.forEach(card => {
                if (card.dataset.value === value) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            document.getElementById('standardNextBtn').disabled = false;
        }

        // Toggle Explanation
        function toggleExplanation() {
            const header = document.querySelector('.explanation-header');
            const content = document.querySelector('.explanation-content');
            
            header.classList.toggle('active');
            content.classList.toggle('show');
        }

        // Navigation
        function nextStep(step) {
            // Validation
            if (step === 1 && formData.children === 0) {
                childrenError.style.display = 'block';
                return;
            }

            if (step === 2) {
                if (formData.income === 0) {
                    alert('Bitte geben Sie Ihr Einkommen an.');
                    return;
                }
                if (!validateIncome()) {
                    return;
                }
            }

            // Move to next step
            currentStep = step + 1;
            updateStepDisplay();
        }

        function previousStep(step) {
            currentStep = step - 1;
            updateStepDisplay();
        }

        function updateStepDisplay() {
            // Update form steps
            const steps = document.querySelectorAll('.form-step');
            steps.forEach(step => {
                if (parseInt(step.dataset.step) === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            // Update progress indicator
            const progressSteps = document.querySelectorAll('.progress-step');
            progressSteps.forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Calculate Result
        function calculateResult() {
            const resultSection = document.getElementById('resultSection');
            
            // Final validation
            if (formData.children === 0) {
                showError(['Sie ben√∂tigen mindestens 1 Kind f√ºr die F√∂rderung.']);
                return;
            }

            if (formData.income === 0) {
                showError(['Bitte geben Sie Ihr Einkommen an.']);
                return;
            }

            const limit = calculateIncomeLimit(formData.children);
            if (formData.income > limit) {
                showError([`Ihr Einkommen √ºberschreitet die F√∂rdergrenze von ${limit.toLocaleString('de-DE')} ‚Ç¨.`]);
                return;
            }

            if (formData.hasProperty === 'yes') {
                showError(['Bei bestehendem Wohneigentum ist leider keine F√∂rderung m√∂glich.']);
                return;
            }

            if (formData.buildingStandard === '') {
                showError(['Bitte best√§tigen Sie, dass Ihr Neubau den KfW-Standard erf√ºllt.']);
                return;
            }

            // Calculate loan amount
            const hasQNG = formData.buildingStandard === 'qng';
            const loanAmount = calculateLoanAmount(formData.children, hasQNG);

            // Show success result
            showSuccess(loanAmount, hasQNG);

            // Update progress to final step
            currentStep = 5;
            updateStepDisplay();
        }

        function calculateLoanAmount(children, hasQNG) {
            if (hasQNG) {
                if (children <= 2) return 220000;
                if (children <= 4) return 250000;
                return 270000;
            } else {
                if (children <= 2) return 170000;
                if (children <= 4) return 200000;
                return 220000;
            }
        }

        function showSuccess(amount, hasQNG) {
            const resultSection = document.getElementById('resultSection');
            
            // Zinss√§tze formatieren
            let zins1, zins2, zins3;
            let updateInfo = '';
            let interhypZins = null;
            let kfwAvgZins = null;
            
            if (zinsdaten && zinsdaten.kfw && zinsdaten.kfw.rates && !zinsdaten.error) {
                // Verwende geladene KfW-Zinss√§tze
                const rate1 = zinsdaten.kfw.rates['4-10_jahre'];
                const rate2 = zinsdaten.kfw.rates['11-25_jahre'];
                const rate3 = zinsdaten.kfw.rates['26-35_jahre'];
                
                zins1 = rate1.effektivzins ? `${rate1.sollzins.toFixed(2).replace('.', ',')} % (${rate1.effektivzins.toFixed(2).replace('.', ',')} %)` : `${rate1.sollzins.toFixed(2).replace('.', ',')} %`;
                zins2 = rate2.effektivzins ? `${rate2.sollzins.toFixed(2).replace('.', ',')} % (${rate2.effektivzins.toFixed(2).replace('.', ',')} %)` : `${rate2.sollzins.toFixed(2).replace('.', ',')} %`;
                zins3 = rate3.effektivzins ? `${rate3.sollzins.toFixed(2).replace('.', ',')} % (${rate3.effektivzins.toFixed(2).replace('.', ',')} %)` : `${rate3.sollzins.toFixed(2).replace('.', ',')} %`;
                
                // Berechne durchschnittlichen KfW-Zins f√ºr Vergleich (10 Jahre Zinsbindung = rate1)
                kfwAvgZins = rate1.sollzins;
                
                // Lade Interhyp-Daten
                if (zinsdaten.interhyp && zinsdaten.interhyp.rates && zinsdaten.interhyp.rates.zinsbindung_10) {
                    interhypZins = zinsdaten.interhyp.rates.zinsbindung_10.zins;
                }
                
                updateInfo = `<p style="text-align: center; color: #666; font-size: 0.85em; margin-top: 10px;">Stand: ${new Date(zinsdaten.updated).toLocaleDateString('de-DE')}</p>`;
            } else {
                // Fallback wenn keine Daten verf√ºgbar
                zins1 = '<strong>Tagesaktuell auf kfw.de</strong>';
                zins2 = '<strong>Tagesaktuell auf kfw.de</strong>';
                zins3 = '<strong>Tagesaktuell auf kfw.de</strong>';
            }
            
            resultSection.innerHTML = `
                <div class="ergebnis-summary-box">
                    <div class="result-icon">üéâ</div>
                    <h2>Herzlichen Gl√ºckwunsch!</h2>
                    <p>Sie haben voraussichtlich Anspruch auf einen KfW-300 Kredit in H√∂he von:</p>
                    <div class="big-amount">${amount.toLocaleString('de-DE')} ‚Ç¨</div>
                </div>

                <div class="result-card">
                    <h3>üìã Ihre Angaben im √úberblick</h3>
                    <div class="result-item">
                        <span class="result-label">üë∂ Anzahl Kinder</span>
                        <span class="result-value">${formData.children}</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">üí∞ Einkommen (zvE)</span>
                        <span class="result-value">${formData.income.toLocaleString('de-DE')} ‚Ç¨</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">üè° Bestehendes Wohneigentum</span>
                        <span class="result-value">Nein</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">üå± Geb√§udestandard</span>
                        <span class="result-value">${hasQNG ? 'KFN-Standard + QNG-Siegel' : 'KFN-Standard (Basis)'}</span>
                    </div>
                </div>

                <div class="result-card" style="margin-top: 20px;">
                    <h3>üìä Kreditkonditionen - Annuit√§tendarlehen</h3>
                    <p class="conditions-intro">
                        Beim Annuit√§tendarlehen zahlen Sie in den ersten Jahren (tilgungsfreie Anlaufzeit) nur Zinsen - 
                        danach gleich hohe monatliche Annuit√§ten.
                    </p>
                    
                    <table class="conditions-table">
                        <thead>
                            <tr>
                                <th>Laufzeit</th>
                                <th>Zinsbindung</th>
                                <th>Tilgungsfreie Anlaufzeit</th>
                                <th>Sollzins pro Jahr (effektiver Jahreszins)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td data-label="Laufzeit">4 bis 10 Jahre</td>
                                <td data-label="Zinsbindung">10 Jahre</td>
                                <td data-label="Tilgungsfreie Anlaufzeit">1 bis 2 Jahre</td>
                                <td data-label="Sollzins pro Jahr">${zins1}</td>
                            </tr>
                            <tr>
                                <td data-label="Laufzeit">11 bis 25 Jahre</td>
                                <td data-label="Zinsbindung">10 Jahre</td>
                                <td data-label="Tilgungsfreie Anlaufzeit">1 bis 3 Jahre</td>
                                <td data-label="Sollzins pro Jahr">${zins2}</td>
                            </tr>
                            <tr>
                                <td data-label="Laufzeit">26 bis 35 Jahre</td>
                                <td data-label="Zinsbindung">10 Jahre</td>
                                <td data-label="Tilgungsfreie Anlaufzeit">1 bis 5 Jahre</td>
                                <td data-label="Sollzins pro Jahr">${zins3}</td>
                            </tr>
                        </tbody>
                    </table>
                    ${updateInfo}
                </div>

                ${interhypZins && kfwAvgZins ? `
                <div class="result-card" style="margin-top: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #50685b;">
                    <h3>üí∞ Zinsvergleich: KfW 300 vs. klassische Baufinanzierung</h3>
                    <p style="color: #666; font-size: 0.95em; margin-bottom: 15px;">
                        Vergleich mit markt√ºblichen Zinss√§tzen (4-10 Jahre Laufzeit, 10 Jahre Zinsbindung, Beleihung < 90%)
                    </p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 8px;">üèõÔ∏è KfW 300</div>
                            <div style="font-size: 2em; font-weight: 700; color: #50685b;">${kfwAvgZins.toFixed(2).replace('.', ',')} %</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Sollzins p.a.</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <div style="font-size: 0.9em; color: #666; font-weight: 600; margin-bottom: 8px;">üè¶ Interhyp (Markt)</div>
                            <div style="font-size: 2em; font-weight: 700; color: #dc3545;">${interhypZins.toFixed(2).replace('.', ',')} %</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Durchschnitt</div>
                        </div>
                    </div>
                    
                    ${kfwAvgZins < interhypZins ? `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-top: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.8em;">‚úÖ</span>
                            <div>
                                <strong style="color: #155724; font-size: 1.1em;">Ihr Vorteil: ${(interhypZins - kfwAvgZins).toFixed(2).replace('.', ',')} % g√ºnstigerer Zins!</strong>
                                <p style="color: #155724; margin: 5px 0 0 0; font-size: 0.9em;">
                                    Bei ${amount.toLocaleString('de-DE')} ‚Ç¨ Darlehenssumme sparen Sie √ºber die Laufzeit mehrere Tausend Euro.
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <p style="text-align: center; color: #666; font-size: 0.8em; margin-top: 15px; font-style: italic;">
                        Quelle Marktdaten: <a href="https://www.interhyp.de/zinsen/" target="_blank" style="color: #50685b;">Interhyp</a> | 
                        Stand: ${new Date(zinsdaten.updated).toLocaleDateString('de-DE')}
                    </p>
                </div>
                ` : ''}

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <!-- PDF CTA -->
                    <div style="background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 12px; padding: 25px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üìÑ</div>
                        <p style="color: #495057; font-size: 0.95em; line-height: 1.4; margin-bottom: 20px;">
                            Jetzt kostenloses PDF anfordern ‚Äì inklusive wichtiger Hinweise zur erfolgreichen Umsetzung
                        </p>
                        <button onclick="generatePDF()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            Kostenloses PDF erstellen
                        </button>
                    </div>

                    <!-- Energieberatung CTA -->
                    <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 12px; padding: 25px; text-align: center;">
                        <div style="font-size: 2em; margin-bottom: 10px;">üî•</div>
                        <p style="color: #155724; font-size: 0.95em; line-height: 1.4; margin-bottom: 20px; font-weight: 600;">
                            Jetzt Energieberatung anfragen und direkt 10 % Nachlass sichern.
                        </p>
                        <button onclick="window.location.href='https://energy-advice-bavaria.de/kontakt/?tab=offer-tab-pane#section-79'" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                            Unverbindliches Angebot anfordern
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="location.reload()" class="btn-navigate btn-previous" style="padding: 14px 40px;">
                        ‚Üª Neue Berechnung starten
                    </button>
                </div>
            `;

            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
            
            // Hilfsfunktion um Bilder zu laden
            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            };

            // Bild f√ºr PDF optimieren (Downscaling + optionale Kompression)
            const optimizeImageForPdf = (img, maxWidthPx, maxHeightPx, mimeType = 'image/jpeg', quality = 0.82) => {
                const scale = Math.min(maxWidthPx / img.width, maxHeightPx / img.height, 1);
                const targetWidth = Math.max(1, Math.round(img.width * scale));
                const targetHeight = Math.max(1, Math.round(img.height * scale));

                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;

                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                return canvas.toDataURL(mimeType, quality);
            };
            
            try {
                // Lade alle ben√∂tigten Bilder
                const titelblatt = await loadImage('./titelblatt300.png');
                const logo = await loadImage('./logo.png');
                const qrCode = await loadImage('./homepagestatistik.png');
                const ablauf = await loadImage('./kfwablauf.png');

                // F√ºr PDF optimierte Bilddaten (reduziert Dateigr√∂√üe massiv)
                const titelblattData = optimizeImageForPdf(titelblatt, 1600, 2300, 'image/jpeg', 0.82);
                const logoData = optimizeImageForPdf(logo, 900, 500, 'image/png');
                const qrCodeData = optimizeImageForPdf(qrCode, 500, 500, 'image/png');
                const ablaufData = optimizeImageForPdf(ablauf, 1600, 2300, 'image/jpeg', 0.82);
                
                // Berechne Seitenverh√§ltnisse
                const logoAspect = logo.width / logo.height;
                const qrAspect = qrCode.width / qrCode.height;
                const ablaufAspect = ablauf.width / ablauf.height;
                
                // Logo: H√∂he 10mm, Breite proportional
                const logoHeight = 10;
                const logoWidth = logoHeight * logoAspect;
                
                // QR-Code: 20mm x 20mm (sollte quadratisch sein)
                const qrSize = 20;
                
                // Ablauf Bild: Maximale Breite 190mm, H√∂he proportional
                const ablaufMaxWidth = 190;
                const ablaufMaxHeight = 240;
                let ablaufWidth, ablaufHeight;
                
                if (ablaufMaxWidth / ablaufAspect <= ablaufMaxHeight) {
                    // Breite ist limitierend
                    ablaufWidth = ablaufMaxWidth;
                    ablaufHeight = ablaufMaxWidth / ablaufAspect;
                } else {
                    // H√∂he ist limitierend
                    ablaufHeight = ablaufMaxHeight;
                    ablaufWidth = ablaufMaxHeight * ablaufAspect;
                }
                
                const ablaufX = (210 - ablaufWidth) / 2; // Zentriert
                
                // Hilfsfunktion f√ºr Kopfzeile (gr√ºner Balken)
                const addHeader = (doc) => {
                    // Gr√ºner Balken oben (helleres Gr√ºn passend zum Titelblatt)
                    doc.setFillColor(80, 104, 91);
                    doc.rect(0, 0, 210, 25, 'F');
                    
                    // Text links
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('KfW - Familienkredit 300 - Ergebnis', 10, 15.5);
                    
                    // Logo rechts (mit korrektem Seitenverh√§ltnis)
                    const logoX = 210 - logoWidth - 5; // 5mm Abstand vom rechten Rand
                    doc.addImage(logoData, 'PNG', logoX, 7.5, logoWidth, logoHeight, 'logoImage', 'FAST');
                };
                
                // Hilfsfunktion f√ºr Fu√üzeile (QR-Code)
                const addFooter = (doc) => {
                    // QR-Code mittig unten (mit korrektem Seitenverh√§ltnis)
                    const qrX = (210 - qrSize) / 2; // Zentriert
                    doc.addImage(qrCodeData, 'PNG', qrX, 272, qrSize, qrSize, 'qrCodeImage', 'FAST');
                };
                
                // === SEITE 1: Titelblatt ===
                doc.addImage(titelblattData, 'JPEG', 0, 0, 210, 297, 'titelblattImage', 'FAST');
                
                // === SEITE 2: Zusammenfassung ===
                doc.addPage();
                
                // Kopfzeile: Gr√ºner Balken mit Logo
                addHeader(doc);
                
                const children = formData.children;
                const income = formData.income;
                const hasProperty = formData.hasProperty === 'no' ? 'Nein' : 'Ja';
                const buildingStandard = formData.buildingStandard === 'with-qng' ? 'KFN-Standard + QNG-Siegel' : 'KFN-Standard (Basis)';
                const amount = calculateLoanAmount(children, formData.buildingStandard === 'with-qng');
                
                // Berechne Zinsen und Ersparnis
                let kfwZins = 0;
                let interhypZins = 0;
                let zinsersparnis = 0;
                let monatlicheRate = 0;
                let monatlicheRateMarkt = 0;
                let monatlicheErsparnis = 0;
                let gesamtersparnis = 0;
                
                if (zinsdaten && zinsdaten.kfw && zinsdaten.interhyp) {
                    kfwZins = zinsdaten.kfw.rates['4-10_jahre'].sollzins;
                    interhypZins = zinsdaten.interhyp.rates.zinsbindung_10.zins;
                    zinsersparnis = interhypZins - kfwZins;
                    
                    // Monatliche Raten f√ºr 10 Jahre (nur Zinsen, da tilgungsfrei)
                    monatlicheRate = (amount * kfwZins / 100) / 12;
                    monatlicheRateMarkt = (amount * interhypZins / 100) / 12;
                    monatlicheErsparnis = monatlicheRateMarkt - monatlicheRate;
                    
                    // Gesamtersparnis √ºber 1 Jahr
                    gesamtersparnis = monatlicheErsparnis * 12;
                }
                
                let yPos = 35;
                
                // Projektdaten
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                
                doc.text('Projektdaten:', 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                yPos += 6;
                doc.text(`Anzahl Kinder: ${children}`, 20, yPos);
                yPos += 5;
                doc.text(`Einkommen (zvE): ${income.toLocaleString('de-DE')} ‚Ç¨`, 20, yPos);
                yPos += 5;
                doc.text(`Bestehendes Wohneigentum: ${hasProperty}`, 20, yPos);
                yPos += 5;
                doc.text(`Geb√§udestandard: ${buildingStandard}`, 20, yPos);
                yPos += 5;
                doc.text(`Kredith√∂he: ${amount.toLocaleString('de-DE')} EUR`, 20, yPos);
                
                // Finanzierungs√ºbersicht Box
                yPos = 70;
                doc.setFillColor(245, 245, 245);
                doc.rect(15, yPos, 180, 92, 'F');
                doc.setDrawColor(200, 200, 200);
                doc.rect(15, yPos, 180, 92, 'S');
                
                yPos += 8;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Finanzierungs√ºbersicht', 20, yPos);
                
                yPos += 10;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const valueX = 185;
                
                // Kreditbetrag
                doc.text('Kreditbetrag:', 25, yPos);
                doc.text(`${amount.toLocaleString('de-DE')} EUR`, valueX, yPos, { align: 'right' });
                yPos += 6;
                doc.text('Max. m√∂glicher KfW-Kredit:', 25, yPos);
                doc.text(`${amount.toLocaleString('de-DE')} EUR`, valueX, yPos, { align: 'right' });
                
                yPos += 10;
                // Zinss√§tze
                doc.setFont(undefined, 'bold');
                doc.text('Zinss√§tze (10 Jahre Zinsbindung):', 25, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 6;
                
                // Hinweis f√ºr l√§ngere Laufzeit
                doc.setFontSize(8);
                doc.setTextColor(200, 0, 0);
                doc.text('Hinweis: L√§ngere Laufzeiten (11-35 Jahre) haben h√∂here KfW-Zinss√§tze.', 25, yPos);
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                yPos += 6;
                
                doc.text('KfW-F√∂rderkredit EH40:', 25, yPos);
                doc.setTextColor(80, 104, 91);
                doc.setFont(undefined, 'bold');
                doc.text(`${kfwZins.toFixed(2).replace('.', ',')} % p.a.`, valueX, yPos, { align: 'right' });
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                yPos += 6;
                
                doc.text('Markt√ºblicher Zins:', 25, yPos);
                doc.text(`${interhypZins.toFixed(2).replace('.', ',')} % p.a.`, valueX, yPos, { align: 'right' });
                
                yPos += 10;
                // Monatliche Belastung
                doc.setFont(undefined, 'bold');
                doc.text('Monatliche Belastung:', 25, yPos);
                doc.setFont(undefined, 'normal');
                yPos += 6;
                doc.text('Mit KfW-F√∂rderung:', 25, yPos);
                doc.text(`${Math.round(monatlicheRate).toLocaleString('de-DE')} EUR`, valueX, yPos, { align: 'right' });
                yPos += 6;
                doc.text('Bei Marktkonditionen:', 25, yPos);
                doc.text(`${Math.round(monatlicheRateMarkt).toLocaleString('de-DE')} EUR`, valueX, yPos, { align: 'right' });
                
                yPos += 8;
                // Monatliche Ersparnis (gr√ºn hervorgehoben)
                doc.setFillColor(80, 104, 91);
                doc.rect(20, yPos - 4, 170, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                const savingsTextY = yPos + 1;
                doc.text('Monatliche Ersparnis:', 25, savingsTextY);
                doc.text(`${Math.round(monatlicheErsparnis).toLocaleString('de-DE')} EUR`, valueX, savingsTextY, { align: 'right' });
                
                // Gro√üer gr√ºner Kasten: Zinsvorteil
                yPos = 168;
                doc.setFillColor(80, 104, 91);
                doc.rect(15, yPos, 180, 20, 'F');
                yPos += 8;
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(`Ihr Zinsvorteil gegen√ºber Marktkredit (1 Jahr):`, 105, yPos, { align: 'center' });
                yPos += 7;
                doc.setFontSize(14);
                doc.text(`${Math.round(gesamtersparnis).toLocaleString('de-DE')} EUR`, 105, yPos, { align: 'center' });

                // Erkl√§rung zum Vergleich (vertikal zentriert zwischen Vorteilskasten und QR)
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                const paragraphX = 15;
                const paragraphWidth = 180;
                const lineHeight = 3.8;
                const blockSpacing = 3.5;

                const infoBlocks = [
                    {
                        title: '√úber diesen Vergleich:',
                        text: 'Diese Berechnung verdeutlicht Ihren massiven Zinsvorteil durch das KfW-Programm 300 im Vergleich zu aktuellen Marktkonditionen.'
                    },
                    {
                        title: 'Zinsersparnis:',
                        text: 'Da der KfW-Zins mit 0,01 % p.a. extrem subventioniert ist, zahlen Sie monatlich fast keine Zinsen.'
                    },
                    {
                        title: 'Monatliche Rate:',
                        text: 'Der angezeigte Betrag von 1 EUR entspricht der tats√§chlichen Belastung w√§hrend der tilgungsfreien Anlaufjahre (je nach Wahl 1 bis 5 Jahre).'
                    },
                    {
                        title: 'Hinweis zur Tilgung:',
                        text: 'Nach Ablauf der tilgungsfreien Zeit kommt zur Zinsrate die Tilgung (R√ºckzahlung des Kredits) hinzu. In einem markt√ºblichen Darlehen m√ºssten Sie Zinsen und Tilgung von Beginn an parallel leisten.'
                    }
                ];

                const preparedBlocks = infoBlocks.map((block) => {
                    const wrappedLines = doc.splitTextToSize(block.text, paragraphWidth);
                    const blockHeight = lineHeight + (wrappedLines.length * lineHeight) + blockSpacing;
                    return { ...block, wrappedLines, blockHeight };
                });

                const totalInfoHeight = preparedBlocks.reduce((sum, block) => sum + block.blockHeight, 0);
                const contentTop = 188;
                const contentBottom = 272;
                yPos = contentTop + ((contentBottom - contentTop - totalInfoHeight) / 2);

                preparedBlocks.forEach((block) => {
                    doc.setFont(undefined, 'bold');
                    doc.text(block.title, paragraphX, yPos);
                    yPos += lineHeight;

                    doc.setFont(undefined, 'normal');
                    doc.text(block.wrappedLines, paragraphX, yPos);
                    yPos += (block.wrappedLines.length * lineHeight) + blockSpacing;
                });
                
                // Reset
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                
                // Fu√üzeile: QR-Code
                addFooter(doc);
                
                // === SEITE 3: KfW Ablauf ===
                doc.addPage();
                
                // Kopfzeile: Gr√ºner Balken mit Logo
                addHeader(doc);
                
                // KfW Ablauf Bild (mit originalen Proportionen, zentriert)
                doc.addImage(ablaufData, 'JPEG', ablaufX, 25, ablaufWidth, ablaufHeight, 'ablaufImage', 'FAST');

                // Klickbarer Link auf Seite 3
                doc.link(57.0, 102.5, 50, 5, {
                    url: 'https://www.energy-advice-bavaria.de'
                });
                
                // Fu√üzeile: QR-Code
                addFooter(doc);
                
                // PDF speichern
                doc.save('KfW-300-Foerderung.pdf');
                
            } catch (error) {
                console.error('Fehler beim PDF-Erstellen:', error);
                alert('Fehler beim Erstellen der PDF. Bitte versuchen Sie es erneut.');
            }
        }

        function showError(messages) {
            const resultSection = document.getElementById('resultSection');
            
            const messageList = messages.map(msg => `<li>${msg}</li>`).join('');
            
            resultSection.innerHTML = `
                <div class="error-result-box">
                    <div class="result-icon">üòî</div>
                    <h2>Leider passen die Kriterien aktuell nicht</h2>
                    <ul>
                        ${messageList}
                    </ul>
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="location.reload()" class="btn-navigate btn-previous" style="padding: 14px 40px;">
                            ‚Üª Neue Berechnung starten
                        </button>
                    </div>
                </div>
            `;

            resultSection.classList.remove('hidden');
            resultSection.scrollIntoView({ behavior: 'smooth' });

            // Update progress to final step
            currentStep = 5;
            updateStepDisplay();
        }

        // Initialize
        updateIncomeLimit();
        loadZinssaetze(); // Lade Zinss√§tze beim Start
    </script>
</body>
</html>